<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title></title>
    <url>%2F2019%2F04%2F29%2Ftest%2F</url>
    <content type="text"><![CDATA[sdfafasf]]></content>
  </entry>
  <entry>
    <title><![CDATA[几个高精度IP定位网站]]></title>
    <url>%2F2017%2F09%2F30%2F%E5%87%A0%E4%B8%AA%E9%AB%98%E7%B2%BE%E5%BA%A6IP%E5%AE%9A%E4%BD%8D%E7%BD%91%E7%AB%99%2F</url>
    <content type="text"><![CDATA[几个高精度IP定位网站：https://ip.rtbasia.com/https://www.opengps.cn/Data/IP/LocHighAcc.aspxhttp://www.ipplus360.com/http://chaipip.com/ IP信息综合查询：https://www.ipip.net/ip.htmlhttps://bgp.he.net/]]></content>
  </entry>
  <entry>
    <title><![CDATA[结合Fluentd实现ngx_lua_waf页面展示]]></title>
    <url>%2F2016%2F10%2F20%2F%E7%BB%93%E5%90%88Fluentd%E5%AE%9E%E7%8E%B0ngx_lua_waf%E9%A1%B5%E9%9D%A2%E5%B1%95%E7%A4%BA%2F</url>
    <content type="text"><![CDATA[0x00 概述最近在看lua_waf,看看怎么搞个web界面出来，于是有了这篇笔记。 上图是大佬分享的waf日志处理流程，不过我这篇文章讲的就简单多了，如下, 纯属搞着玩儿： ngx_lua_waf简介 ngx_lua_waf，是一个轻量级、高性能的WAF模块。 防止sql注入，本地包含，部分溢出，fuzzing测试，XSS, SSRF等web攻击 防止svn/备份之类文件泄漏 防止ApacheBench之类压力测试工具的攻击 屏蔽常见的扫描黑客工具，扫描器 屏蔽异常的网络请求 屏蔽图片附件类目录php执行权限 防止webshell上传 详情（安装方法）见：https://github.com/loveshell/ngx_lua_waf Fluentd简介 Fluentd，是一个开源收集事件和日志系统，它目前提供150+扩展插件让你存储大数据用于日志搜索，数据分析和存储。这里我们用fluentd搜集lua_waf日志。 官网：http://www.fluentd.org/ 文档中心：http://docs.fluentd.org/v0.12/articles/quickstart 0x01 Fluentd安装lua_waf安装略，网上有很多教程，直接开始fluentd部署。 1.通过rpm安装，执行如下命令（如果有报错，按实际报错提示处理即可）：1$ curl -L https://toolbelt.treasuredata.com/sh/install-redhat-td-agent2.sh | sh 2.安装好之后便可以启动： 1234$ /etc/init.d/td-agent start Starting td-agent: [ OK ]$ /etc/init.d/td-agent statustd-agent (pid 21678) is running... 3.配置，如何取日志，如何进行处理分析都在这里进行配置（td-agent.conf）： 1$ sudo vi /etc/td-agent/td-agent.conf 4.必要的插件，我们这里是要将取得的日志送到mysql做分析以及页面展示，所以需要下载fluent-plugin-mysql（fluentd默认没有mysql插件）。 1gem地址：https://rubygems.org/gems/fluent-plugin-mysql/versions/0.1.5 安装命令： 1234yum install mysql-devel（依赖包）/usr/sbin/td-agent-gem install jsonpath/usr/sbin/td-agent-gem install mysql2-cs-bind/usr/sbin/td-agent-gem install fluent-plugin-mysql -v 0.1.5 ngx_lua_waf日志格式 init.lua代码片段: 1234567891011121314151617#ngx_lua_waf拦截日志格式，能够与fluentd正则匹配。function log(method,url,data,ruletag) if attacklog then local realIp = getClientIp() local ua = ngx.var.http_user_agent local servername=ngx.var.server_name local time=ngx.localtime() if ua then line = realIp..&quot; &quot;..servername..&quot; \&quot;&quot;..time..&quot;\&quot; \&quot;&quot;..method..&quot; &quot;..servername..url..&quot;\&quot; \&quot;&quot;..data..&quot;\&quot; \&quot;&quot;..ua..&quot;\&quot; \&quot;&quot;..ruletag..&quot;\&quot;\n&quot; else line = realIp..&quot; &quot;..servername..&quot; \&quot;&quot;..time..&quot;\&quot; \&quot;&quot;..method..&quot; &quot;..servername..url..&quot;\&quot; \&quot;&quot;..data..&quot;\&quot; - \&quot;&quot;..ruletag..&quot;\&quot;\n&quot; end local filename = logpath..&apos;/&apos;..servername..&quot;_sec.log&quot; write(filename,line) endend fluentd配置 td-agent.conf片段： 12345678910111213141516171819202122#将/usr/local/nginx/logs/hack/ngx_lua_waf_sec.log日志实时同步到mysql&lt;source&gt; @type tail path /usr/local/nginx/logs/hack/ngx_lua_waf_sec.log pos_file /var/log/td-agent/httpd-access.log.pos format /^(?&lt;ip&gt;[^ ]*) (?&lt;website&gt;[^ ]*) &quot;(?&lt;time&gt;[^\&quot;]*)&quot; &quot;(?&lt;method&gt;\S+)(?: +(?&lt;path&gt;[^\&quot;]*))?&quot; &quot;(?&lt;demo&gt;[^\&quot;]*)&quot; &quot;(?&lt;agent&gt;[^\&quot;]*)&quot; &quot;(?&lt;rule&gt;[^\&quot;]*)&quot;$/ time_format %Y-%m-%d %H:%M:%S tag test.http&lt;/source&gt;&lt;match test.**&gt; @type mysql_bulk host 172.20.3.64 database waf username root password qwe@123456 column_names id,ip,website,time,method,path,demo,agent,rule table waflog time_format %Y-%m-%d %H:%M:%S flush_interval 3s&lt;/match&gt; 0x02 mysql接收waf日志下面这张表存放waf的拦截日志，比较简单。接收上面td-agent传过来的数据。 123456789101112131415161718192021222324252627282930313233use pscan;SET FOREIGN_KEY_CHECKS=0;-- ------------------------------ Table structure for waflog-- ----------------------------DROP TABLE IF EXISTS `waflog`;CREATE TABLE `waflog` ( `id` int(100) NOT NULL, `ip` varchar(100) DEFAULT NULL, `website` varchar(255) DEFAULT NULL, `time` datetime DEFAULT NULL, `method` varchar(255) DEFAULT NULL, `path` varchar(255) DEFAULT NULL, `demo` varchar(255) DEFAULT NULL, `agent` varchar(255) DEFAULT NULL, `rule` varchar(255) DEFAULT NULL, PRIMARY KEY (`id`)) ENGINE=MyISAM DEFAULT CHARSET=utf8;-- ------------------------------ Records of waflog-- ----------------------------INSERT INTO `waflog` VALUES (&apos;1&apos;, &apos;172.20.3.64&apos;, &apos;www.maliciouskr.cc&apos;, &apos;2016-09-08 20:18:03&apos;, &apos;GET&apos;, &apos;/dump.php?&lt;img&lt;!--+--&gt; src=x onerror=alert(9549);//&gt;&lt;!-- --&gt;&apos;, &apos;-&apos;, &apos;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.21 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.21&apos;, &apos;(?:define|eval|file_get_contents|include|require|require_once|shell_exec|phpinfo|system|passthru|preg_\\\\w+|execute|echo|print|print_r|var_dump|(fp)open|alert|showmodaldialog)\\\\(\\\&quot;&apos;);INSERT INTO `waflog` VALUES (&apos;2&apos;, &apos;172.20.3.64&apos;, &apos;www.maliciouskr.cc&apos;, &apos;2016-09-08 20:18:03&apos;, &apos;GET&apos;, &apos;/dump.php?&lt;img&lt;!--+--&gt; src=x onerror=alert(9549);//&gt;&lt;!-- --&gt;&apos;, &apos;-&apos;, &apos;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.21 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.21&apos;, &apos;(?:define|eval|file_get_contents|include|require|require_once|shell_exec|phpinfo|system|passthru|preg_\\\\w+|execute|echo|print|print_r|var_dump|(fp)open|alert|showmodaldialog)\\\\(\\\&quot;&apos;);INSERT INTO `waflog` VALUES (&apos;3&apos;, &apos;172.20.3.64&apos;, &apos;www.maliciouskr.cc&apos;, &apos;2016-09-08 20:18:03&apos;, &apos;GET&apos;, &apos;/dump.php?&lt;img&lt;!--+--&gt; src=x onerror=alert(9549);//&gt;&lt;!-- --&gt;&apos;, &apos;-&apos;, &apos;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.21 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.21&apos;, &apos;(?:define|eval|file_get_contents|include|require|require_once|shell_exec|phpinfo|system|passthru|preg_\\\\w+|execute|echo|print|print_r|var_dump|(fp)open|alert|showmodaldialog)\\\\(\\\&quot;&apos;);INSERT INTO `waflog` VALUES (&apos;4&apos;, &apos;172.20.3.64&apos;, &apos;www.maliciouskr.cc&apos;, &apos;2016-09-08 20:18:03&apos;, &apos;GET&apos;, &apos;/dump.php?&lt;img&lt;!--+--&gt; src=x onerror=alert(9549);//&gt;&lt;!-- --&gt;&apos;, &apos;-&apos;, &apos;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.21 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.21&apos;, &apos;(?:define|eval|file_get_contents|include|require|require_once|shell_exec|phpinfo|system|passthru|preg_\\\\w+|execute|echo|print|print_r|var_dump|(fp)open|alert|showmodaldialog)\\\\(\\\&quot;&apos;);INSERT INTO `waflog` VALUES (&apos;5&apos;, &apos;172.20.3.64&apos;, &apos;www.maliciouskr.cc&apos;, &apos;2016-09-08 20:18:03&apos;, &apos;GET&apos;, &apos;/dump.php?&lt;img&lt;!--+--&gt; src=x onerror=alert(9549);//&gt;&lt;!-- --&gt;&apos;, &apos;-&apos;, &apos;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.21 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.21&apos;, &apos;(?:define|eval|file_get_contents|include|require|require_once|shell_exec|phpinfo|system|passthru|preg_\\\\w+|execute|echo|print|print_r|var_dump|(fp)open|alert|showmodaldialog)\\\\(\\\&quot;&apos;);INSERT INTO `waflog` VALUES (&apos;6&apos;, &apos;172.20.3.64&apos;, &apos;www.maliciouskr.cc&apos;, &apos;2016-09-08 20:18:03&apos;, &apos;GET&apos;, &apos;/dump.php?&lt;img&lt;!--+--&gt; src=x onerror=alert(9549);//&gt;&lt;!-- --&gt;&apos;, &apos;-&apos;, &apos;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.21 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.21&apos;, &apos;(?:define|eval|file_get_contents|include|require|require_once|shell_exec|phpinfo|system|passthru|preg_\\\\w+|execute|echo|print|print_r|var_dump|(fp)open|alert|showmodaldialog)\\\\(\\\&quot;&apos;);INSERT INTO `waflog` VALUES (&apos;7&apos;, &apos;172.20.3.64&apos;, &apos;www.maliciouskr.cc&apos;, &apos;2016-09-08 20:18:03&apos;, &apos;GET&apos;, &apos;/dump.php?&lt;img&lt;!--+--&gt; src=x onerror=alert(9549);//&gt;&lt;!-- --&gt;&apos;, &apos;-&apos;, &apos;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.21 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.21&apos;, &apos;(?:define|eval|file_get_contents|include|require|require_once|shell_exec|phpinfo|system|passthru|preg_\\\\w+|execute|echo|print|print_r|var_dump|(fp)open|alert|showmodaldialog)\\\\(\\\&quot;&apos;);INSERT INTO `waflog` VALUES (&apos;8&apos;, &apos;172.20.3.64&apos;, &apos;www.maliciouskr.cc&apos;, &apos;2016-09-08 20:18:03&apos;, &apos;GET&apos;, &apos;/dump.php?&lt;img&lt;!--+--&gt; src=x onerror=alert(9549);//&gt;&lt;!-- --&gt;&apos;, &apos;-&apos;, &apos;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.21 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.21&apos;, &apos;(?:define|eval|file_get_contents|include|require|require_once|shell_exec|phpinfo|system|passthru|preg_\\\\w+|execute|echo|print|print_r|var_dump|(fp)open|alert|showmodaldialog)\\\\(\\\&quot;&apos;);INSERT INTO `waflog` VALUES (&apos;9&apos;, &apos;172.20.3.64&apos;, &apos;www.maliciouskr.cc&apos;, &apos;2016-09-08 20:18:03&apos;, &apos;GET&apos;, &apos;/dump.php?&lt;img&lt;!--+--&gt; src=x onerror=alert(9549);//&gt;&lt;!-- --&gt;&apos;, &apos;-&apos;, &apos;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.21 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.21&apos;, &apos;(?:define|eval|file_get_contents|include|require|require_once|shell_exec|phpinfo|system|passthru|preg_\\\\w+|execute|echo|print|print_r|var_dump|(fp)open|alert|showmodaldialog)\\\\(\\\&quot;&apos;); 0x03 页面展示 源码（php+mysql+Bootstrap）见github，代码质量为初学者水平，见谅。]]></content>
      <tags>
        <tag>Testing</tag>
        <tag>入侵检测</tag>
        <tag>waf</tag>
      </tags>
  </entry>
</search>
